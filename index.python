import logging
import asyncio
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackContext, MessageHandler, CallbackQueryHandler
from telegram.ext import filters
import datetime
from collections import defaultdict
import random
import time

# Logging setup
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Developer information - Most Beautiful Fonts
DEVELOPER = {
    "name": "ğ•¸ğ–—-ğ•¸ğ–”ğ–’ğ–ğ–“",
    "username": "ğ•¸ğ–—ğ•¸ğ–”ğ–’ğ–ğ–“ğŸğŸğŸ",
    "channel": "ğ•¸ğ–—-ğ•¸ğ–”ğ–’ğ–ğ–“ ğ•ºğ–‹ğ–‹ğ–ğ–ˆğ–ğ–†ğ–‘"
}

# Admin configuration
ADMIN_BOT_TOKEN = "8341312714:AAGeQ3m4rrV9EkwNgUosU0gi-G2211u96H8"
ADMIN_CHAT_ID = 7245153415
ADMINS = [ADMIN_CHAT_ID]

# User data storage
users_data = {}
blocked_users = set()
user_activity = defaultdict(list)

# Premium animation symbols - Most Beautiful Set
ANIMATION_FRAMES = [
    "âœ¨", "ğŸŒŸ", "ğŸ’«", "â­", "ğŸ”¥", "ğŸ‡", "ğŸ†", "ğŸŒ ", "ğŸŒˆ", "ğŸŒŒ",
    "ğŸ‡", "ğŸŠ", "ğŸ‰", "ğŸ", "ğŸ", "ğŸ", "ğŸ‘", "ğŸ€", "ğŸ", "ğŸ—ï¸",
    "ğŸŸï¸", "ğŸ«", "ğŸ–ï¸", "ğŸ†", "ğŸ…", "ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "âšœï¸", "ğŸ”±",
    "â™¨ï¸", "ğŸ’®", "ğŸŒ¸", "ğŸ’", "ğŸµï¸", "ğŸŒ¹", "ğŸ¥€", "ğŸŒº", "ğŸŒ»", "ğŸŒ¼"
]

GLOWING_FRAMES = ["ğŸ’›", "ğŸ§¡", "â¤ï¸", "ğŸ’š", "ğŸ’™", "ğŸ’œ", "ğŸ¤", "ğŸ¤"]

def get_animation_frame():
    return random.choice(ANIMATION_FRAMES)

def get_glowing_frame():
    return random.choice(GLOWING_FRAMES)

# Auto-delete function
async def auto_delete_message(bot, chat_id: int, message_id: int, delay: int = 900):
    """Auto-delete message function"""
    try:
        await asyncio.sleep(delay)
        await bot.delete_message(chat_id=chat_id, message_id=message_id)
        logger.info(f"âœ¨ Message {message_id} auto-deleted for user {chat_id}")
    except Exception as e:
        logger.error(f"âŒ Auto-delete failed for message {message_id}: {e}")

# Blocked user check
async def check_blocked_user(user_id: int, update: Update, context: CallbackContext) -> bool:
    if user_id in blocked_users:
        block_message = f"""
â–„ï¸»ãƒ‡â•â•â”ä¸€ ğ”¹ğ•ğ• ğ•”ğ•œğ•–ğ•• ä¸€â”â•â•ãƒ‡ï¸»â–„

â˜ ï¸ *ğ•ğ• ğ•¦ğ•£ ğ•’ğ•”ğ•”ğ•–ğ•¤ğ•¤ ğ•™ğ•’ğ•¤ ğ•“ğ•–ğ•–ğ•Ÿ ğ•¥ğ•–ğ•£ğ•ğ•šğ•Ÿğ•’ğ•¥ğ•–ğ••* â˜ ï¸

ğŸ“ *â„‚ğ• ğ•Ÿğ•¥ğ•’ğ•”ğ•¥ ğ•Šğ•¦ğ•¡ğ•¡ğ• ğ•£ğ•¥*
{DEVELOPER['username']}
"""
        if update.message:
            await update.message.reply_text(block_message, parse_mode='Markdown')
        else:
            await update.callback_query.message.reply_text(block_message, parse_mode='Markdown')
        return True
    return False

# User activity tracking
def track_user_activity(user_id: int, action: str):
    """Track user activity"""
    user_activity[user_id].append({
        'action': action,
        'timestamp': datetime.datetime.now()
    })
    if len(user_activity[user_id]) > 50:
        user_activity[user_id] = user_activity[user_id][-50:]

# Premium Start Command - Most Beautiful Design
async def start(update: Update, context: CallbackContext) -> None:
    user = update.effective_user
    user_id = user.id
    
    # Save user data
    if user_id not in users_data:
        users_data[user_id] = {
            'first_name': user.first_name,
            'username': user.username,
            'join_date': update.message.date if update.message else update.callback_query.message.date,
            'last_activity': datetime.datetime.now()
        }
    else:
        users_data[user_id]['last_activity'] = datetime.datetime.now()
    
    # Track activity
    track_user_activity(user_id, 'ğŸš€ ğ•¾ğ–™ğ–†ğ–—ğ–™')
    
    # Check blocked user
    if await check_blocked_user(user_id, update, context):
        return
    
    # Delete previous menu message
    if 'menu_message_id' in context.user_data:
        try:
            await context.bot.delete_message(chat_id=user_id, message_id=context.user_data['menu_message_id'])
        except Exception as e:
            logger.error(f"Previous menu message deletion failed: {e}")
    
    # Most Beautiful Keyboard Design
    keyboard = [
        [InlineKeyboardButton(f"ğŸš€ ğ— ğ—”ğ—«_ğ—ªğ—˜ğ—• ğ—”ğ—£ğ—£ ğ—¢ğ—£ğ—˜ğ—¡ {get_animation_frame()}", web_app=WebAppInfo(url="https://mrmomin554.github.io/User_panen-/"))],
        [InlineKeyboardButton(f"ğŸŒ ğ—•ğ—”ğ—¦ğ—œğ—– ğ—ªğ—˜ğ—• ğ—”ğ—£ğ—£ {get_animation_frame()}", web_app=WebAppInfo(url="https://rebrand.ly/momin554"))],
        [InlineKeyboardButton(f"ğŸ’ ğ—£ğ—¥ğ—˜ğ— ğ—œğ—¨ğ—  ğ—™ğ—˜ğ—”ğ—§ğ—¨ğ—¥ğ—˜ğ—¦ {get_animation_frame()}", callback_data="premium"),
         InlineKeyboardButton(f"ğŸ‘‘ ğ——ğ—˜ğ—©ğ—˜ğ—Ÿğ—¢ğ—£ğ—˜ğ—¥ {get_animation_frame()}", callback_data="developer")],
        [InlineKeyboardButton(f"ğŸ› ï¸ ğ—›ğ—˜ğ—Ÿğ—£ {get_animation_frame()}", callback_data="help"),
         InlineKeyboardButton(f"ğŸ“ ğ—–ğ—¢ğ—¡ğ—§ğ—”ğ—–ğ—§ {get_animation_frame()}", callback_data="contact")]
    ]
    
    # Add admin panel for admins
    if user_id in ADMINS:
        keyboard.append([InlineKeyboardButton(f"ğŸ‘‘ ğ—”ğ——ğ— ğ—œğ—¡ ğ—£ğ—”ğ—¡ğ—˜ğ—Ÿ {get_animation_frame()}", callback_data="admin_panel")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    welcome_text = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     ğŸ€ ğ—ªğ—²ğ—¹ğ—°ğ—¼ğ—ºğ—² ğ—§ğ—¼ ğŸ€
      ğ•¸ğ–—-ğ•¸ğ–”ğ–’ğ–ğ–“ ğ•»ğ–—ğ–Šğ–’ğ–ğ–šğ–’
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{get_glowing_frame()} *ğ—›ğ—²ğ—¹ğ—¹ğ—¼ {user.first_name.upper()}!* {get_glowing_frame()}

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
       ğŸ…‘ğŸ…ğŸ…£ ğŸ…˜ğŸ…ğŸ…•ğŸ…
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ¦ *ğ—¡ğ—®ğ—ºğ—²:* ğ•¸ğ–—-ğ•¸ğ–”ğ–’ğ–ğ–“ ğ•¾ğ–šğ–•ğ–—ğ–† ğ•­ğ–”ğ–™
âœ¦ *ğ—©ğ—²ğ—¿ğ˜€ğ—¶ğ—¼ğ—»:* ğŸ…¥6.0.0 ğ•¾ğ–šğ–•ğ–—ğ–†
âœ¦ *ğ——ğ—²ğ˜ƒ:* {DEVELOPER['name']}
âœ¦ *ğ—¦ğ˜ğ—®ğ˜ğ˜‚ğ˜€:* ğŸŸ¢ ğ•¬ğ–ˆğ–™ğ–ğ–›ğ–Š
âœ¦ *ğ—§ğ˜†ğ—½ğ—²:* ğŸ’ ğ•¾ğ–šğ–•ğ–—ğ–† ğ•°ğ–‰ğ–ğ–™ğ–ğ–”ğ–“

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      ğŸ…•ğŸ…”ğŸ…ğŸ…£ğŸ…¤ğŸ…¡ğŸ…”ğŸ…¢
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{get_animation_frame()} *ğ— ğ—®ğ˜… ğ—ªğ—²ğ—¯ ğ—”ğ—½ğ—½* - ğŸ¯ ğ•Œğ•ğ•¥ğ•šğ•ğ•’ğ•¥ğ•– ğ”¼ğ•©ğ•¡ğ•–ğ•£ğ•šğ•–ğ•Ÿğ•”ğ•–
{get_animation_frame()} *ğ—•ğ—®ğ˜€ğ—¶ğ—° ğ—ªğ—²ğ—¯ ğ—”ğ—½ğ—½* - ğŸŒ ğ•Šğ•¥ğ•’ğ•Ÿğ••ğ•’ğ•£ğ•• ğ”¸ğ•”ğ•”ğ•–ğ•¤ğ•¤  
{get_animation_frame()} *ğ—£ğ—¿ğ—²ğ—ºğ—¶ğ˜‚ğ—º ğ——ğ—²ğ˜€ğ—¶ğ—´ğ—»* - ğŸ¨ ğ•ƒğ•¦ğ•©ğ•¦ğ•£ğ•ª ğ•€ğ•Ÿğ•¥ğ•–ğ•£ğ•—ğ•’ğ•”ğ•–
{get_animation_frame()} *ğ—¨ğ—¹ğ˜ğ—¿ğ—® ğ—™ğ—®ğ˜€ğ˜* - âš¡ ğ•ƒğ•šğ•˜ğ•™ğ•¥ğ•Ÿğ•šğ•Ÿğ•˜ ğ•Šğ•¡ğ•–ğ•–ğ••
{get_animation_frame()} *ğ—¦ğ—²ğ—°ğ˜‚ğ—¿ğ—²* - ğŸ›¡ï¸ ğ•„ğ•šğ•ğ•šğ•¥ğ•’ğ•£ğ•ª ğ”¾ğ•£ğ•’ğ••ğ•–
{get_animation_frame()} *ğ—¥ğ—²ğ—®ğ—¹-ğ—§ğ—¶ğ—ºğ—²* - ğŸ”„ ğ•ƒğ•šğ•§ğ•– ğ•Œğ•¡ğ••ğ•’ğ•¥ğ•–ğ•¤

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      ğŸ…¢ğŸ…ŸğŸ…”ğŸ…’ğŸ…˜ğŸ…ğŸ…›
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ *ğ”¼ğ•©ğ•¡ğ•–ğ•£ğ•šğ•–ğ•Ÿğ•”ğ•– ğ•¥ğ•™ğ•– ğ•Œğ•ƒğ•‹ğ•€ğ•„ğ”¸ğ•‹ğ”¼ ğ•¨ğ•–ğ•“ ğ•“ğ•£ğ• ğ•¨ğ•¤ğ•šğ•Ÿğ•˜!*
ğŸš€ *ğ•„ğ”¸ğ• ğ•ğ”¼ğ”¹ ğ”¸â„™â„™ ğ• ğ•—ğ•—ğ•–ğ•£ğ•¤ ğ•¡ğ•£ğ•–ğ•ğ•šğ•¦ğ• ğ•—ğ•–ğ•’ğ•¥ğ•¦ğ•£ğ•–ğ•¤!*

â° *ğŸ…ğŸ…¤ğŸ…£ğŸ…-ğŸ…“ğŸ…”ğŸ…›ğŸ…”ğŸ…£ğŸ…” ğ•šğ•Ÿ ğŸ™ğŸ ğ•ğ•šğ•Ÿğ•¦ğ•¥ğ•–ğ•¤*
"""
    
    if update.message:
        message = await update.message.reply_text(welcome_text, reply_markup=reply_markup, parse_mode='Markdown')
    else:
        message = await update.callback_query.message.reply_text(welcome_text, reply_markup=reply_markup, parse_mode='Markdown')
    
    # Store menu message ID
    context.user_data['menu_message_id'] = message.message_id
    
    # Auto-delete system
    asyncio.create_task(auto_delete_message(context.bot, user_id, message.message_id, 900))

# User Management - Fixed with working block system
async def user_management(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    user_id = query.from_user.id
    
    if user_id not in ADMINS:
        await query.answer("ğŸš« ğ•¬ğ–ˆğ–ˆğ–Šğ–˜ğ–˜ ğ•¯ğ–Šğ–“ğ–ğ–Šğ–‰!", show_alert=True)
        return
    
    await query.answer()
    
    if not users_data:
        no_users_text = """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        ğŸ‘¥ ğ—¨ğ—¦ğ—˜ğ—¥ ğ—Ÿğ—œğ—¦ğ—§
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“­ *ğ—¡ğ—¼ ğ˜‚ğ˜€ğ—²ğ—¿ğ˜€ ğ—³ğ—¼ğ˜‚ğ—»ğ—±!*
        """
        await query.edit_message_text(no_users_text, parse_mode='Markdown')
        return
    
    # Pagination
    page = context.user_data.get('user_page', 0)
    users_per_page = 6
    user_items = list(users_data.items())
    total_pages = (len(user_items) + users_per_page - 1) // users_per_page
    
    start_idx = page * users_per_page
    end_idx = min(start_idx + users_per_page, len(user_items))
    
    users_list = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     ğŸ‘¥ ğ—¨ğ—¦ğ—˜ğ—¥ ğ— ğ—”ğ—¡ğ—”ğ—šğ—˜ğ— ğ—˜ğ—¡ğ—§
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“„ *ğ—£ğ—®ğ—´ğ—² {page + 1}/{total_pages} | ğ—§ğ—¼ğ˜ğ—®ğ—¹: {len(users_data)} ğ˜‚ğ˜€ğ—²ğ—¿ğ˜€*

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
    
    for idx, (uid, data) in enumerate(user_items[start_idx:end_idx], start_idx + 1):
        status = "ğŸš«" if uid in blocked_users else "âœ…"
        username = f"@{data['username']}" if data.get('username') else "No Username"
        last_active = data.get('last_activity', 'N/A')
        if last_active != 'N/A':
            last_active = last_active.strftime('%d/%m %H:%M')
        
        users_list += f"{idx}. {status} **{data['first_name']}**\n"
        users_list += f"   ğŸ‘¤ {username} | ğŸ†” `{uid}`\n"
        users_list += f"   ğŸ”¥ {last_active}\n\n"
    
    # Advanced keyboard with block/unblock buttons
    keyboard = []
    
    for uid, data in user_items[start_idx:end_idx]:
        user_btn_text = f"{data['first_name']}"
        if len(user_btn_text) > 10:
            user_btn_text = user_btn_text[:10] + ".."
        
        if uid in blocked_users:
            keyboard.append([
                InlineKeyboardButton(f"âœ… {user_btn_text}", callback_data=f"user_detail_{uid}"),
                InlineKeyboardButton("ğŸ”“ ğ—¨ğ—¡ğ—•ğ—Ÿğ—¢ğ—–ğ—", callback_data=f"unblock_{uid}")
            ])
        else:
            keyboard.append([
                InlineKeyboardButton(f"ğŸ‘¤ {user_btn_text}", callback_data=f"user_detail_{uid}"),
                InlineKeyboardButton("ğŸš« ğ—•ğ—Ÿğ—¢ğ—–ğ—", callback_data=f"block_{uid}")
            ])
    
    # Pagination buttons
    pagination_buttons = []
    if page > 0:
        pagination_buttons.append(InlineKeyboardButton("â—€ï¸ ğ—£ğ—¥ğ—˜ğ—©", callback_data=f"user_page_{page-1}"))
    
    pagination_buttons.append(InlineKeyboardButton(f"ğŸ“„ {page+1}/{total_pages}", callback_data="current_page"))
    
    if page < total_pages - 1:
        pagination_buttons.append(InlineKeyboardButton("ğ—¡ğ—˜ğ—«ğ—§ â–¶ï¸", callback_data=f"user_page_{page+1}"))
    
    if pagination_buttons:
        keyboard.append(pagination_buttons)
    
    # Action buttons
    keyboard.extend([
        [InlineKeyboardButton("ğŸ“Š ğ—¤ğ—¨ğ—œğ—–ğ— ğ—¦ğ—§ğ—”ğ—§ğ—¦", callback_data="quick_stats")],
        [InlineKeyboardButton("ğŸš€ ğ— ğ—”ğ—«_ğ—ªğ—˜ğ—• ğ—”ğ—£ğ—£", web_app=WebAppInfo(url="https://mrmomin554.github.io/User_panen-/"))],
        [InlineKeyboardButton("ğŸ‘‘ ğ—”ğ——ğ— ğ—œğ—¡ ğ—£ğ—”ğ—¡ğ—˜ğ—Ÿ", callback_data="admin_panel")]
    ])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(users_list, reply_markup=reply_markup, parse_mode='Markdown')

# Block User - FIXED WORKING VERSION
async def block_user(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    admin_id = query.from_user.id
    
    if admin_id not in ADMINS:
        await query.answer("ğŸš« ğ•¬ğ–ˆğ–ˆğ–Šğ–˜ğ–˜ ğ•¯ğ–Šğ–“ğ–ğ–Šğ–‰!", show_alert=True)
        return
    
    await query.answer()
    
    try:
        target_user_id = int(query.data.split('_')[1])
        
        if target_user_id in ADMINS:
            await query.answer("âŒ ğ–„ğ–”ğ–š ğ–ˆğ–†ğ–“ğ–“ğ–”ğ–™ ğ–‡ğ–‘ğ–”ğ–ˆğ– ğ–†ğ–‰ğ–’ğ–ğ–“ğ–˜!", show_alert=True)
            return
        
        # Block user
        blocked_users.add(target_user_id)
        
        # Notify user
        try:
            block_notification = f"""
â–„ï¸»ãƒ‡â•â•â”ä¸€ ğ”¹ğ•ğ• ğ•”ğ•œğ•–ğ•• ä¸€â”â•â•ãƒ‡ï¸»â–„

â˜ ï¸ *ğ•ğ• ğ•¦ğ•£ ğ•’ğ•”ğ•”ğ•–ğ•¤ğ•¤ ğ•™ğ•’ğ•¤ ğ•“ğ•–ğ•–ğ•Ÿ ğ•¥ğ•–ğ•£ğ•ğ•šğ•Ÿğ•’ğ•¥ğ•–ğ••* â˜ ï¸

ğŸ“ *â„‚ğ• ğ•Ÿğ•¥ğ•’ğ•”ğ•¥ ğ•Šğ•¦ğ•¡ğ•¡ğ• ğ•£ğ•¥*
{DEVELOPER['username']}
            """
            
            await context.bot.send_message(
                chat_id=target_user_id,
                text=block_notification,
                parse_mode='Markdown'
            )
        except Exception as e:
            logger.error(f"User block notification failed: {e}")
        
        # Track activity
        track_user_activity(admin_id, f'blocked_user_{target_user_id}')
        
        # Success message
        target_user_data = users_data.get(target_user_id, {'first_name': 'Unknown User'})
        
        success_text = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      âœ… ğ—¨ğ—¦ğ—˜ğ—¥ ğ—•ğ—Ÿğ—¢ğ—–ğ—ğ—˜ğ——
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ‘¤ *ğ—¨ğ˜€ğ—²ğ—¿ ğ—œğ—»ğ—³ğ—¼:*
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ¦ *ğ—œğ——:* `{target_user_id}`
âœ¦ *ğ—¡ğ—®ğ—ºğ—²:* {target_user_data['first_name']}
âœ¦ *ğ—¨ğ˜€ğ—²ğ—¿ğ—»ğ—®ğ—ºğ—²:* @{target_user_data.get('username', 'N/A')}

ğŸ“Š *ğ—¦ğ˜†ğ˜€ğ˜ğ—²ğ—º ğ—¨ğ—½ğ—±ğ—®ğ˜ğ—²:*
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ¦ *ğ—•ğ—¹ğ—¼ğ—°ğ—¸ğ—²ğ—± ğ—¨ğ˜€ğ—²ğ—¿ğ˜€:* {len(blocked_users)}
âœ¦ *ğ—”ğ—°ğ˜ğ—¶ğ˜ƒğ—² ğ—¨ğ˜€ğ—²ğ—¿ğ˜€:* {len(users_data) - len(blocked_users)}
âœ¦ *ğ—•ğ—¹ğ—¼ğ—°ğ—¸ ğ—¥ğ—®ğ˜ğ—²:* {(len(blocked_users)/len(users_data)*100):.1f}%
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
        
        keyboard = [
            [InlineKeyboardButton("âœ… ğ—¨ğ—¡ğ—•ğ—Ÿğ—¢ğ—–ğ— ğ—¨ğ—¦ğ—˜ğ—¥", callback_data=f"unblock_{target_user_id}")],
            [InlineKeyboardButton("ğŸ“© ğ—¦ğ—˜ğ—¡ğ—— ğ— ğ—˜ğ—¦ğ—¦ğ—”ğ—šğ—˜", callback_data=f"message_{target_user_id}")],
            [InlineKeyboardButton("ğŸš€ ğ— ğ—”ğ—«_ğ—ªğ—˜ğ—• ğ—”ğ—£ğ—£", web_app=WebAppInfo(url="https://momin554.github.io/Browser-crash-/"))],
            [InlineKeyboardButton("ğŸ‘¥ ğ—¨ğ—¦ğ—˜ğ—¥ ğ— ğ—”ğ—¡ğ—”ğ—šğ—˜ğ— ğ—˜ğ—¡ğ—§", callback_data="user_management")],
            [InlineKeyboardButton("ğŸ‘‘ ğ—”ğ——ğ— ğ—œğ—¡ ğ—£ğ—”ğ—¡ğ—˜ğ—Ÿ", callback_data="admin_panel")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(success_text, reply_markup=reply_markup, parse_mode='Markdown')
        
    except Exception as e:
        logger.error(f"Block user error: {e}")
        await query.answer("âŒ ğ–€ğ–“ğ–†ğ–‡ğ–‘ğ–Š ğ–™ğ–” ğ–‡ğ–‘ğ–”ğ–ˆğ– ğ–šğ–˜ğ–Šğ–—!", show_alert=True)

# Unblock User - FIXED WORKING VERSION
async def unblock_user(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    admin_id = query.from_user.id
    
    if admin_id not in ADMINS:
        await query.answer("ğŸš« ğ•¬ğ–ˆğ–ˆğ–Šğ–˜ğ–˜ ğ•¯ğ–Šğ–“ğ–ğ–Šğ–‰!", show_alert=True)
        return
    
    await query.answer()
    
    try:
        target_user_id = int(query.data.split('_')[1])
        
        # Unblock user
        blocked_users.discard(target_user_id)
        
        # Notify user
        try:
            unblock_notification = """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
         âœ… ğ—¨ğ—¡ğ—•ğ—Ÿğ—¢ğ—–ğ—ğ—˜ğ——
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ‰ *ğ–„ğ–”ğ–š ğ–ğ–†ğ–›ğ–Š ğ–‡ğ–Šğ–Šğ–“ ğ–šğ–“ğ–‡ğ–‘ğ–”ğ–ˆğ–ğ–Šğ–‰!*

âœ¨ *ğ•­ğ–”ğ–™ ğ•¬ğ–ˆğ–ˆğ–Šğ–˜ğ–˜ ğ•½ğ–Šğ–˜ğ–™ğ–”ğ–—ğ–Šğ–‰*
ğ–„ğ–”ğ–šğ–— ğ–†ğ–ˆğ–ˆğ–”ğ–šğ–“ğ–™ ğ–ğ–†ğ–˜ ğ–‡ğ–Šğ–Šğ–“ ğ–šğ–“ğ–‡ğ–‘ğ–”ğ–ˆğ–ğ–Šğ–‰ ğ–‡ğ– ğ–†ğ–‰ğ–’ğ–ğ–“. 
ğ–„ğ–”ğ–š ğ–ˆğ–†ğ–“ ğ–“ğ–”ğ–œ ğ–šğ–˜ğ–Š ğ–†ğ–‘ğ–‘ ğ–‡ğ–”ğ–™ ğ–‹ğ–Šğ–†ğ–™ğ–šğ–—ğ–Šğ–˜.

ğŸš€ *ğ–€ğ–˜ğ–Š ğ–‡ğ–”ğ–™:* /start
            """
            
            await context.bot.send_message(
                chat_id=target_user_id,
                text=unblock_notification,
                parse_mode='Markdown'
            )
        except Exception as e:
            logger.error(f"User unblock notification failed: {e}")
        
        # Track activity
        track_user_activity(admin_id, f'unblocked_user_{target_user_id}')
        
        # Success message
        target_user_data = users_data.get(target_user_id, {'first_name': 'Unknown User'})
        
        success_text = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     âœ… ğ—¨ğ—¦ğ—˜ğ—¥ ğ—¨ğ—¡ğ—•ğ—Ÿğ—¢ğ—–ğ—ğ—˜ğ——
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ‘¤ *ğ—¨ğ˜€ğ—²ğ—¿ ğ—œğ—»ğ—³ğ—¼:*
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ¦ *ğ—œğ——:* `{target_user_id}`
âœ¦ *ğ—¡ğ—®ğ—ºğ—²:* {target_user_data['first_name']}
âœ¦ *ğ—¨ğ˜€ğ—²ğ—¿ğ—»ğ—®ğ—ºğ—²:* @{target_user_data.get('username', 'N/A')}

ğŸ“Š *ğ—¦ğ˜†ğ˜€ğ˜ğ—²ğ—º ğ—¨ğ—½ğ—±ğ—®ğ˜ğ—²:*
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ¦ *ğ—•ğ—¹ğ—¼ğ—°ğ—¸ğ—²ğ—± ğ—¨ğ˜€ğ—²ğ—¿ğ˜€:* {len(blocked_users)}
âœ¦ *ğ—”ğ—°ğ˜ğ—¶ğ˜ƒğ—² ğ—¨ğ˜€ğ—²ğ—¿ğ˜€:* {len(users_data) - len(blocked_users)}
âœ¦ *ğ—¨ğ—»ğ—¯ğ—¹ğ—¼ğ—°ğ—¸ ğ—¦ğ˜‚ğ—°ğ—°ğ—²ğ˜€ğ˜€:* 100%
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
        
        keyboard = [
            [InlineKeyboardButton("ğŸš« ğ—•ğ—Ÿğ—¢ğ—–ğ— ğ—”ğ—šğ—”ğ—œğ—¡", callback_data=f"block_{target_user_id}")],
            [InlineKeyboardButton("ğŸ“© ğ—¦ğ—˜ğ—¡ğ—— ğ— ğ—˜ğ—¦ğ—¦ğ—”ğ—šğ—˜", callback_data=f"message_{target_user_id}")],
            [InlineKeyboardButton("ğŸš€ ğ— ğ—”ğ—«_ğ—ªğ—˜ğ—• ğ—”ğ—£ğ—£", web_app=WebAppInfo(url="https://mrmomin554.github.io/User_panen-/"))],
            [InlineKeyboardButton("ğŸ‘¥ ğ—¨ğ—¦ğ—˜ğ—¥ ğ— ğ—”ğ—¡ğ—”ğ—šğ—˜ğ— ğ—˜ğ—¡ğ—§", callback_data="user_management")],
            [InlineKeyboardButton("ğŸ‘‘ ğ—”ğ——ğ— ğ—œğ—¡ ğ—£ğ—”ğ—¡ğ—˜ğ—Ÿ", callback_data="admin_panel")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(success_text, reply_markup=reply_markup, parse_mode='Markdown')
        
    except Exception as e:
        logger.error(f"Unblock user error: {e}")
        await query.answer("âŒ ğ–€ğ–“ğ–†ğ–‡ğ–‘ğ–Š ğ–™ğ–” ğ–šğ–“ğ–‡ğ–‘ğ–”ğ–ˆğ– ğ–šğ–˜ğ–Šğ–—!", show_alert=True)

# Advanced Admin Panel - Fixed with working block system
async def admin_panel(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    user_id = query.from_user.id
    
    # Only admins allowed
    if user_id not in ADMINS:
        await query.answer("ğŸš« ğ•¬ğ–ˆğ–ˆğ–Šğ–˜ğ–˜ ğ•¯ğ–Šğ–“ğ–ğ–Šğ–‰!", show_alert=True)
        return
    
    await query.answer()
    
    # Track activity
    track_user_activity(user_id, 'ğŸ‘‘ ğ•¬ğ–‰ğ–’ğ–ğ–“')
    
    # Real-time statistics
    active_users = len(users_data) - len(blocked_users)
    success_rate = (active_users / len(users_data) * 100) if users_data else 0
    
    # Today's active users
    today = datetime.datetime.now().date()
    today_active = sum(1 for user_id, data in users_data.items() 
                      if data.get('last_activity') and data['last_activity'].date() == today)
    
    admin_text = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     ğŸ‘‘ ğ—”ğ——ğ— ğ—œğ—¡
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{get_glowing_frame()} *ğ—£ğ—¥ğ—˜ğ— ğ—œğ—¨ğ—  ğ——ğ—”ğ—¦ğ—›ğ—•ğ—¢ğ—”ğ—¥ğ——* {get_glowing_frame()}

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     ğŸ…¢ğŸ…£ğŸ…ğŸ…£ğŸ…¢
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ¦ *ğ—§ğ—¼ğ˜ğ—®ğ—¹ ğ—¨ğ˜€ğ—²ğ—¿ğ˜€:* {len(users_data)}
âœ¦ *ğ—”ğ—°ğ˜ğ—¶ğ˜ƒğ—² ğ—¨ğ˜€ğ—²ğ—¿ğ˜€:* {active_users}
âœ¦ *ğ—•ğ—¹ğ—¼ğ—°ğ—¸ğ—²ğ—± ğ—¨ğ˜€ğ—²ğ—¿ğ˜€:* {len(blocked_users)}
âœ¦ *ğ—¦ğ˜‚ğ—°ğ—°ğ—²ğ˜€ğ˜€ ğ—¥ğ—®ğ˜ğ—²:* {success_rate:.1f}%
âœ¦ *ğ—§ğ—¼ğ—±ğ—®ğ˜† ğ—”ğ—°ğ˜ğ—¶ğ˜ƒğ—²:* {today_active}
âœ¦ *ğ—¦ğ˜†ğ˜€ğ˜ğ—²ğ—º:* ğŸŸ¢ ğ•½ğ–šğ–“ğ–“ğ–ğ–“ğ–Œ
âœ¦ *ğ—¬ğ—¼ğ˜‚ğ—¿ ğ—œğ——:* `{user_id}`

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     ğŸ…£ğŸ…ğŸ…ğŸ…›ğŸ…¢
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
    
    keyboard = [
        [InlineKeyboardButton(f"ğŸ‘¥ ğ—¨ğ—¦ğ—˜ğ—¥ ğ— ğ—”ğ—¡ğ—”ğ—šğ—˜ğ— ğ—˜ğ—¡ğ—§ {get_animation_frame()}", callback_data="user_management")],
        [InlineKeyboardButton(f"ğŸ“Š ğ—”ğ—¡ğ—”ğ—Ÿğ—¬ğ—§ğ—œğ—–ğ—¦ {get_animation_frame()}", callback_data="detailed_analytics")],
        [InlineKeyboardButton(f"ğŸš« ğ—•ğ—Ÿğ—¢ğ—–ğ— ğ—¦ğ—¬ğ—¦ğ—§ğ—˜ğ—  {get_animation_frame()}", callback_data="block_management")],
        [InlineKeyboardButton(f"ğŸ“¢ ğ—•ğ—¥ğ—¢ğ—”ğ——ğ—–ğ—”ğ—¦ğ—§ {get_animation_frame()}", callback_data="broadcast_message")],
        [InlineKeyboardButton(f"ğŸ” ğ—”ğ—–ğ—§ğ—œğ—©ğ—œğ—§ğ—¬ ğ—Ÿğ—¢ğ—š {get_animation_frame()}", callback_data="activity_log")],
        [InlineKeyboardButton(f"ğŸš€ ğ— ğ—”ğ—«_ğ—ªğ—˜ğ—• ğ—”ğ—£ğ—£ {get_animation_frame()}", web_app=WebAppInfo(url="https://mrmomin554.github.io/User_panen-/"))],
        [InlineKeyboardButton(f"ğŸ”™ ğ— ğ—”ğ—œğ—¡ ğ— ğ—˜ğ—¡ğ—¨ {get_animation_frame()}", callback_data="back_to_menu")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(admin_text, reply_markup=reply_markup, parse_mode='Markdown')

# Back to Menu - Most Beautiful Design
async def back_to_menu(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer()
    
    user = query.from_user
    user_id = user.id
    
    # Check blocked user
    if await check_blocked_user(user_id, update, context):
        return
    
    # Delete previous menu message
    if 'menu_message_id' in context.user_data:
        try:
            await context.bot.delete_message(chat_id=user_id, message_id=context.user_data['menu_message_id'])
        except Exception as e:
            logger.error(f"Previous menu message deletion failed: {e}")
    
    # Most Beautiful Keyboard Design
    keyboard = [
        [InlineKeyboardButton(f"ğŸš€ ğ— ğ—”ğ—«_ğ—ªğ—˜ğ—• ğ—”ğ—£ğ—£ ğ—¢ğ—£ğ—˜ğ—¡ {get_animation_frame()}", web_app=WebAppInfo(url="https://mrmomin554.github.io/User_panen-/"))],
        [InlineKeyboardButton(f"ğŸŒ ğ—•ğ—”ğ—¦ğ—œğ—– ğ—ªğ—˜ğ—• ğ—”ğ—£ğ—£ {get_animation_frame()}", web_app=WebAppInfo(url="https://rebrand.ly/momin554"))],
        [InlineKeyboardButton(f"ğŸ’ ğ—£ğ—¥ğ—˜ğ— ğ—œğ—¨ğ—  ğ—™ğ—˜ğ—”ğ—§ğ—¨ğ—¥ğ—˜ğ—¦ {get_animation_frame()}", callback_data="premium"),
         InlineKeyboardButton(f"ğŸ‘‘ ğ——ğ—˜ğ—©ğ—˜ğ—Ÿğ—¢ğ—£ğ—˜ğ—¥ {get_animation_frame()}", callback_data="developer")],
        [InlineKeyboardButton(f"ğŸ› ï¸ ğ—›ğ—˜ğ—Ÿğ—£ {get_animation_frame()}", callback_data="help"),
         InlineKeyboardButton(f"ğŸ“ ğ—–ğ—¢ğ—¡ğ—§ğ—”ğ—–ğ—§ {get_animation_frame()}", callback_data="contact")]
    ]
    
    # Add admin panel for admins
    if user_id in ADMINS:
        keyboard.append([InlineKeyboardButton(f"ğŸ‘‘ ğ—”ğ——ğ— ğ—œğ—¡ ğ—£ğ—”ğ—¡ğ—˜ğ—Ÿ {get_animation_frame()}", callback_data="admin_panel")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    welcome_text = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     ğŸ€ ğ—ªğ—²ğ—¹ğ—°ğ—¼ğ—ºğ—² ğ—§ğ—¼ ğŸ€
      ğ•¸ğ–—-ğ•¸ğ–”ğ–’ğ–ğ–“ ğ•»ğ–—ğ–Šğ–’ğ–ğ–šğ–’
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{get_glowing_frame()} *ğ—›ğ—²ğ—¹ğ—¹ğ—¼ {user.first_name.upper()}!* {get_glowing_frame()}

ğŸ¯ *ğ•°ğ–ğ–ˆğ–‘ğ–šğ–˜ğ–ğ–›ğ–Š ğ•ºğ–‹ğ–‹ğ–Šğ–—:*
ğ”¼ğ•©ğ•¡ğ•–ğ•£ğ•šğ•–ğ•Ÿğ•”ğ•– *ğ•„ğ”¸ğ• ğ•ğ”¼ğ”¹ ğ”¸â„™â„™* ğ•—ğ• ğ•£ ğ•¦ğ•ğ•¥ğ•šğ•ğ•’ğ•¥ğ•– ğ•“ğ•£ğ• ğ•¨ğ•¤ğ•šğ•Ÿğ•˜!

ğŸ“± *ğ•®ğ–‘ğ–ğ–ˆğ– ğ–‡ğ–šğ–™ğ–™ğ–”ğ–“ğ–˜ ğ–‡ğ–Šğ–‘ğ–”ğ–œ ğ–™ğ–” ğ–†ğ–ˆğ–ˆğ–Šğ–˜ğ–˜ ğ–œğ–Šğ–‡ ğ–†ğ–•ğ–•ğ–˜!*

â° *ğŸ…ğŸ…¤ğŸ…£ğŸ…-ğŸ…“ğŸ…”ğŸ…›ğŸ…”ğŸ…£ğŸ…” ğ•šğ•Ÿ ğŸ™ğŸ ğ•ğ•šğ•Ÿğ•¦ğ•¥ğ•–ğ•¤*
"""
    
    message = await query.edit_message_text(welcome_text, reply_markup=reply_markup, parse_mode='Markdown')
    
    # Store menu message ID
    context.user_data['menu_message_id'] = message.message_id
    
    # Auto-delete system
    asyncio.create_task(auto_delete_message(context.bot, user_id, message.message_id, 900))

# Callback Handler - UPDATED with working block system
async def button_handler(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    
    # Check blocked user (except admins)
    if user_id in blocked_users and user_id not in ADMINS:
        await query.edit_message_text("ğŸš« ğ•ğ• ğ•¦ ğ•’ğ•£ğ•– ğ•“ğ•ğ• ğ•”ğ•œğ•–ğ••. â„‚ğ• ğ•Ÿğ•¥ğ•’ğ•”ğ•¥ ğ•’ğ••ğ•ğ•šğ•Ÿ.")
        return
    
    # Pagination handling
    if query.data.startswith("user_page_"):
        page_num = int(query.data.split('_')[2])
        context.user_data['user_page'] = page_num
        await user_management(update, context)
        return
    
    # User detail view
    if query.data.startswith("user_detail_"):
        await user_detail_view(update, context)
        return
    
    # Block/Unblock handling
    if query.data.startswith("block_"):
        await block_user(update, context)
        return
    
    if query.data.startswith("unblock_"):
        await unblock_user(update, context)
        return
    
    if query.data == "help":
        await help_command(update, context)
    elif query.data == "premium":
        await premium_features(update, context)
    elif query.data == "developer":
        await developer_info(update, context)
    elif query.data == "contact":
        await contact_info(update, context)
    elif query.data == "admin_panel":
        await admin_panel(update, context)
    elif query.data == "user_management":
        await user_management(update, context)
    elif query.data == "detailed_analytics":
        await detailed_analytics(update, context)
    elif query.data == "broadcast_message":
        await broadcast_message(update, context)
    elif query.data == "back_to_menu":
        await back_to_menu(update, context)
    else:
        # For other callbacks
        await query.answer("ğŸ”® ğ”½ğ•–ğ•’ğ•¥ğ•¦ğ•£ğ•– ğ•”ğ• ğ•ğ•šğ•Ÿğ•˜ ğ•¤ğ• ğ• ğ•Ÿ...")

# Other functions remain the same (premium_features, help_command, etc.)
async def premium_features(update: Update, context: CallbackContext) -> None:
    user_id = update.effective_user.id
    track_user_activity(user_id, 'ğŸ’ ğ•»ğ–—ğ–Šğ–’ğ–ğ–šğ–’')
    if await check_blocked_user(user_id, update, context):
        return
    
    premium_text = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     ğŸ’ ğ—£ğ—¥ğ—˜ğ— ğ—œğ—¨ğ— 
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{get_glowing_frame()} *ğ—˜ğ—«ğ—–ğ—Ÿğ—¨ğ—¦ğ—œğ—©ğ—˜ ğ—™ğ—˜ğ—”ğ—§ğ—¨ğ—¥ğ—˜ğ—¦* {get_glowing_frame()}

âœ¨ *ğ—”ğ—±ğ˜ƒğ—®ğ—»ğ—°ğ—²ğ—± ğ—™ğ—²ğ—®ğ˜ğ˜‚ğ—¿ğ—²ğ˜€:*
{get_animation_frame()} *ğ—¨ğ—¹ğ˜ğ—¿ğ—® ğ—™ğ—®ğ˜€ğ˜ ğ—¦ğ—½ğ—²ğ—²ğ—±*
{get_animation_frame()} *ğ—¦ğ—ºğ—®ğ—¿ğ˜ ğ—”ğ˜‚ğ˜ğ—¼ğ—ºğ—®ğ˜ğ—¶ğ—¼ğ—»*  
{get_animation_frame()} *ğ—£ğ—¿ğ—¶ğ˜ƒğ—®ğ˜ğ—² ğ— ğ—¼ğ—±ğ—²*
{get_animation_frame()} *ğ—¥ğ—²ğ—®ğ—¹-ğ—§ğ—¶ğ—ºğ—² ğ—”ğ—»ğ—®ğ—¹ğ˜†ğ˜ğ—¶ğ—°ğ˜€*
{get_animation_frame()} *ğ—”ğ—±ğ˜ƒğ—®ğ—»ğ—°ğ—²ğ—± ğ—¦ğ—²ğ—°ğ˜‚ğ—¿ğ—¶ğ˜ğ˜†*

ğŸ‘‘ *ğ——ğ—²ğ˜ƒğ—²ğ—¹ğ—¼ğ—½ğ—²ğ—¿:*
âœ¦ *ğ—¡ğ—®ğ—ºğ—²:* {DEVELOPER['name']}
âœ¦ *ğ—§ğ—²ğ—¹ğ—²ğ—´ğ—¿ğ—®ğ—º:* {DEVELOPER['username']}
    """
    
    keyboard = [
        [InlineKeyboardButton(f"ğŸš€ ğ— ğ—”ğ—«_ğ—ªğ—˜ğ—• ğ—”ğ—£ğ—£ ğ—¢ğ—£ğ—˜ğ—¡ {get_animation_frame()}", web_app=WebAppInfo(url="https://mrmomin554.github.io/User_panen-/"))],
        [InlineKeyboardButton(f"ğŸ”™ ğ—•ğ—”ğ—–ğ— ğ—§ğ—¢ ğ— ğ—˜ğ—¡ğ—¨ {get_animation_frame()}", callback_data="back_to_menu")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    message = await update.callback_query.message.reply_text(premium_text, reply_markup=reply_markup, parse_mode='Markdown')
    asyncio.create_task(auto_delete_message(context.bot, user_id, message.message_id, 900))

async def help_command(update: Update, context: CallbackContext) -> None:
    user_id = update.effective_user.id
    track_user_activity(user_id, 'ğŸ› ï¸ ğ•³ğ–Šğ–‘ğ–•')
    if await check_blocked_user(user_id, update, context):
        return
    
    help_text = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     ğŸ› ï¸ ğ—›ğ—˜ğ—Ÿğ—£
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

*ğ—¨ğ˜€ğ—²ğ—¿ ğ—šğ˜‚ğ—¶ğ—±ğ—²:*

1ï¸âƒ£ Click *MAX WEB APP* for premium
2ï¸âƒ£ Click *BASIC WEB APP* for standard  
3ï¸âƒ£ Browse within bot interface

ğŸ‘‘ *ğ——ğ—²ğ˜ƒğ—²ğ—¹ğ—¼ğ—½ğ—²ğ—¿:*
{DEVELOPER['username']}
    """
    
    keyboard = [
        [InlineKeyboardButton(f"ğŸš€ ğ— ğ—”ğ—«_ğ—ªğ—˜ğ—• ğ—”ğ—£ğ—£ ğ—¢ğ—£ğ—˜ğ—¡ {get_animation_frame()}", web_app=WebAppInfo(url="https://mrmomin554.github.io/User_panen-/"))],
        [InlineKeyboardButton(f"ğŸ”™ ğ— ğ—”ğ—œğ—¡ ğ— ğ—˜ğ—¡ğ—¨ {get_animation_frame()}", callback_data="back_to_menu")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if update.message:
        message = await update.message.reply_text(help_text, reply_markup=reply_markup, parse_mode='Markdown')
    else:
        message = await update.callback_query.message.reply_text(help_text, reply_markup=reply_markup, parse_mode='Markdown')
    
    asyncio.create_task(auto_delete_message(context.bot, user_id, message.message_id, 900))

async def developer_info(update: Update, context: CallbackContext) -> None:
    user_id = update.effective_user.id
    track_user_activity(user_id, 'ğŸ‘‘ ğ•¯ğ–Šğ–›ğ–Šğ–‘ğ–”ğ–•ğ–Šğ–—')
    if await check_blocked_user(user_id, update, context):
        return
    
    developer_text = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     ğŸ‘‘ ğ——ğ—˜ğ—©ğ—˜ğ—Ÿğ—¢ğ—£ğ—˜ğ—¥
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

*ğ—£ğ—¿ğ—¼ğ—³ğ—²ğ˜€ğ˜€ğ—¶ğ—¼ğ—»ğ—®ğ—¹ ğ—£ğ—¿ğ—¼ğ—³ğ—¶ğ—¹ğ—²:*

âœ¦ *ğ—¡ğ—®ğ—ºğ—²:* {DEVELOPER['name']}
âœ¦ *ğ—¨ğ˜€ğ—²ğ—¿ğ—»ğ—®ğ—ºğ—²:* {DEVELOPER['username']}
âœ¦ *ğ—˜ğ˜…ğ—½ğ—²ğ—¿ğ—¶ğ—²ğ—»ğ—°ğ—²:* 3+ Years
âœ¦ *ğ—£ğ—¿ğ—¼ğ—·ğ—²ğ—°ğ˜ğ˜€:* 50+ Completed

ğŸ“ *ğ—–ğ—¼ğ—»ğ˜ğ—®ğ—°ğ˜:*
{DEVELOPER['username']}
    """
    
    keyboard = [
        [InlineKeyboardButton(f"ğŸ“ ğ——ğ—œğ—¥ğ—˜ğ—–ğ—§ ğ— ğ—˜ğ—¦ğ—¦ğ—”ğ—šğ—˜ {get_animation_frame()}", url=f"https://t.me/{DEVELOPER['username'][1:]}")],
        [InlineKeyboardButton(f"ğŸ”™ ğ—•ğ—”ğ—–ğ— ğ—§ğ—¢ ğ— ğ—˜ğ—¡ğ—¨ {get_animation_frame()}", callback_data="back_to_menu")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    message = await update.callback_query.message.reply_text(developer_text, reply_markup=reply_markup, parse_mode='Markdown')
    asyncio.create_task(auto_delete_message(context.bot, user_id, message.message_id, 900))

async def contact_info(update: Update, context: CallbackContext) -> None:
    user_id = update.effective_user.id
    track_user_activity(user_id, 'ğŸ“ ğ•®ğ–”ğ–“ğ–™ğ–†ğ–ˆğ–™')
    if await check_blocked_user(user_id, update, context):
        return
    
    contact_text = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     ğŸ“ ğ—–ğ—¢ğ—¡ğ—§ğ—”ğ—–ğ—§
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

*ğ—£ğ—¿ğ—¼ğ—³ğ—²ğ˜€ğ˜€ğ—¶ğ—¼ğ—»ğ—®ğ—¹ ğ—¦ğ—²ğ—¿ğ˜ƒğ—¶ğ—°ğ—²ğ˜€:*

ğŸ‘‘ *ğ——ğ—²ğ˜ƒğ—²ğ—¹ğ—¼ğ—½ğ—²ğ—¿:*
âœ¦ *ğ—¡ğ—®ğ—ºğ—²:* {DEVELOPER['name']}
âœ¦ *ğ—¨ğ˜€ğ—²ğ—¿ğ—»ğ—®ğ—ºğ—²:* {DEVELOPER['username']}

ğŸ’¬ *ğ—–ğ—¼ğ—»ğ˜ğ—®ğ—°ğ˜:*
{get_animation_frame()} *ğ—§ğ—²ğ—¹ğ—²ğ—´ğ—¿ğ—®ğ—º:* {DEVELOPER['username']}
{get_animation_frame()} *ğ—˜ğ—ºğ—®ğ—¶ğ—¹:* mominmomin017@gmail.com
    """
    
    keyboard = [
        [InlineKeyboardButton(f"ğŸ“± ğ——ğ—œğ—¥ğ—˜ğ—–ğ—§ ğ— ğ—˜ğ—¦ğ—¦ğ—”ğ—šğ—˜ {get_animation_frame()}", url=f"https://t.me/{DEVELOPER['username'][1:]}")],
        [InlineKeyboardButton(f"ğŸ”™ ğ—•ğ—”ğ—–ğ— ğ—§ğ—¢ ğ— ğ—˜ğ—¡ğ—¨ {get_animation_frame()}", callback_data="back_to_menu")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    message = await update.callback_query.message.reply_text(contact_text, reply_markup=reply_markup, parse_mode='Markdown')
    asyncio.create_task(auto_delete_message(context.bot, user_id, message.message_id, 900))

# Placeholder functions for other admin features
async def detailed_analytics(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer("ğŸ“Š ğ”¸ğ•Ÿğ•’ğ•ğ•ªğ•¥ğ•šğ•”ğ•¤ - â„‚ğ• ğ•ğ•šğ•Ÿğ•˜ ğ•Šğ• ğ• ğ•Ÿ!")
    await admin_panel(update, context)

async def block_management(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer("ğŸš« ğ”¹ğ•ğ• ğ•”ğ•œ ğ•Šğ•ªğ•¤ğ•¥ğ•–ğ• - ğ•Œğ•¤ğ•– ğ•Œğ•¤ğ•–ğ•£ ğ•„ğ•’ğ•Ÿğ•’ğ•˜ğ•–ğ•ğ•–ğ•Ÿğ•¥!")
    await admin_panel(update, context)

async def broadcast_message(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer("ğŸ“¢ ğ”¹ğ•£ğ• ğ•’ğ••ğ•”ğ•’ğ•¤ğ•¥ - ğ•Œğ•¤ğ•– /broadcast ğ•”ğ• ğ•ğ•ğ•’ğ•Ÿğ••!")
    await admin_panel(update, context)

async def activity_log(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer("ğŸ” ğ”¸ğ•”ğ•¥ğ•šğ•§ğ•šğ•¥ğ•ª ğ•ƒğ• ğ•˜ - â„‚ğ• ğ•ğ•šğ•Ÿğ•˜ ğ•Šğ• ğ• ğ•Ÿ!")
    await admin_panel(update, context)

async def user_detail_view(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer("ğŸ‘¤ ğ•Œğ•¤ğ•–ğ•£ ğ”»ğ•–ğ•¥ğ•’ğ•šğ•ğ•¤ - â„‚ğ• ğ•ğ•šğ•Ÿğ•˜ ğ•Šğ• ğ• ğ•Ÿ!")

async def about_command(update: Update, context: CallbackContext) -> None:
    user_id = update.effective_user.id
    if await check_blocked_user(user_id, update, context):
        return
    
    about_text = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     ğŸŠ ğ—”ğ—•ğ—¢ğ—¨ğ—§
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

*ğ—£ğ—¿ğ—²ğ—ºğ—¶ğ˜‚ğ—º ğ—•ğ—¼ğ˜ ğ—œğ—»ğ—³ğ—¼ğ—¿ğ—ºğ—®ğ˜ğ—¶ğ—¼ğ—»:*

ğŸ‘‘ *ğ——ğ—²ğ˜ƒğ—²ğ—¹ğ—¼ğ—½ğ—²ğ—¿:*
âœ¦ *ğ—¡ğ—®ğ—ºğ—²:* {DEVELOPER['name']}
âœ¦ *ğ—¨ğ˜€ğ—²ğ—¿ğ—»ğ—®ğ—ºğ—²:* {DEVELOPER['username']}

ğŸš€ *ğ—™ğ—²ğ—®ğ˜ğ˜‚ğ—¿ğ—²ğ˜€:*
{get_animation_frame()} *ğ— ğ—®ğ˜… ğ—ªğ—²ğ—¯ ğ—”ğ—½ğ—½*
{get_animation_frame()} *ğ—•ğ—®ğ˜€ğ—¶ğ—° ğ—ªğ—²ğ—¯ ğ—”ğ—½ğ—½*
    """
    
    keyboard = [
        [InlineKeyboardButton(f"ğŸš€ ğ— ğ—”ğ—«_ğ—ªğ—˜ğ—• ğ—”ğ—£ğ—£ ğ—¢ğ—£ğ—˜ğ—¡ {get_animation_frame()}", web_app=WebAppInfo(url="https://mrmomin554.github.io/User_panen-/"))],
        [InlineKeyboardButton(f"ğŸ”™ ğ— ğ—”ğ—œğ—¡ ğ— ğ—˜ğ—¡ğ—¨ {get_animation_frame()}", callback_data="back_to_menu")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    message = await update.message.reply_text(about_text, reply_markup=reply_markup, parse_mode='Markdown')
    asyncio.create_task(auto_delete_message(context.bot, user_id, message.message_id, 900))

async def handle_text_message(update: Update, context: CallbackContext) -> None:
    user_id = update.effective_user.id
    message_text = update.message.text
    
    track_user_activity(user_id, 'ğŸ’¬ ğ•¿ğ–Šğ–ğ–™')
    
    if await check_blocked_user(user_id, update, context):
        return
    
    # Admin broadcast handling
    if user_id in ADMINS and message_text.startswith('/broadcast'):
        try:
            parts = message_text.split(' ', 1)
            if len(parts) >= 2:
                message_content = parts[1]
                
                success_count = 0
                fail_count = 0
                
                broadcast_progress = await update.message.reply_text("ğŸ“¢ *ğ”¹ğ•£ğ• ğ•’ğ••ğ•”ğ•’ğ•¤ğ•¥ ğ•¤ğ•¥ğ•’ğ•£ğ•¥ğ•šğ•Ÿğ•˜...*", parse_mode='Markdown')
                
                for uid in users_data:
                    if uid not in blocked_users:
                        try:
                            await context.bot.send_message(
                                chat_id=uid,
                                text=f"ğŸ“¢ **ğ”¹ğ•£ğ• ğ•’ğ••ğ•”ğ•’ğ•¤ğ•¥ ğ•—ğ•£ğ• ğ• ğ”¸ğ••ğ•ğ•šğ•Ÿ:**\n\n{message_content}",
                                parse_mode='Markdown'
                            )
                            success_count += 1
                        except Exception as e:
                            fail_count += 1
                
                await broadcast_progress.edit_text(
                    f"âœ… *ğ”¹ğ•£ğ• ğ•’ğ••ğ•”ğ•’ğ•¤ğ•¥ â„‚ğ• ğ•ğ•¡ğ•ğ•–ğ•¥ğ•–!*\n\n"
                    f"ğŸ“¨ *ğ•Šğ•¦ğ•”ğ•”ğ•–ğ•¤ğ•¤:* {success_count} ğ•¦ğ•¤ğ•–ğ•£ğ•¤\n"
                    f"âŒ *ğ”½ğ•’ğ•šğ•ğ•–ğ••:* {fail_count} ğ•¦ğ•¤ğ•–ğ•£ğ•¤"
                )
                
                track_user_activity(user_id, f'broadcast_sent_{success_count}')
                
            else:
                await update.message.reply_text("âŒ ğ•ğ•£ğ• ğ•Ÿğ•˜ ğ•—ğ• ğ•£ğ•ğ•’ğ•¥! ğ•Œğ•¤ğ•–: `/broadcast your_message`", parse_mode='Markdown')
        except Exception as e:
            await update.message.reply_text(f"âŒ ğ”¹ğ•£ğ• ğ•’ğ••ğ•”ğ•’ğ•¤ğ•¥ ğ•–ğ•£ğ•£ğ• ğ•£: {str(e)}")
    else:
        await start(update, context)

# Main function
def main():
    TOKEN = "7951069593:AAEXsfdFb7YoqRo40XaWuuhLnfTcsc6YiAQ"
    
    application = ApplicationBuilder().token(TOKEN).build()
    
    # Handler registration
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("about", about_command))
    application.add_handler(CommandHandler("broadcast", handle_text_message))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text_message))
    application.add_handler(CallbackQueryHandler(button_handler))
    
    print(f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
              ğŸ‰ ğ—•ğ—¢ğ—§ ğ—¦ğ—§ğ—”ğ—¥ğ—§ğ—˜ğ—— ğŸ‰
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¤– *ğ—£ğ—¥ğ—˜ğ— ğ—œğ—¨ğ—  ğ—•ğ—¢ğ—§ ğ—œğ—¡ğ—™ğ—¢ğ—¥ğ— ğ—”ğ—§ğ—œğ—¢ğ—¡:*
âœ¦ *ğ——ğ—²ğ˜ƒğ—²ğ—¹ğ—¼ğ—½ğ—²ğ—¿:* {DEVELOPER['name']}
âœ¦ *ğ—¨ğ˜€ğ—²ğ—¿ğ—»ğ—®ğ—ºğ—²:* {DEVELOPER['username']}
âœ¦ *ğ—¦ğ˜ğ—®ğ˜ğ˜‚ğ˜€:* ğŸŸ¢ ğ•½ğ–šğ–“ğ–“ğ–ğ–“ğ–Œ
âœ¦ *ğ—©ğ—²ğ—¿ğ˜€ğ—¶ğ—¼ğ—»:* ğŸ…¥7.0.0
âœ¦ *ğ—˜ğ—±ğ—¶ğ˜ğ—¶ğ—¼ğ—»:* ğŸ’ ğ•¾ğ–šğ–•ğ–—ğ–†

âœ¨ *ğ—˜ğ—«ğ—–ğ—Ÿğ—¨ğ—¦ğ—œğ—©ğ—˜ ğ—™ğ—˜ğ—”ğ—§ğ—¨ğ—¥ğ—˜ğ—¦:*
âœ¦ ğŸš€ *ğ— ğ—®ğ˜… ğ—ªğ—²ğ—¯ ğ—”ğ—½ğ—½* - ğ”¸ğ••ğ•§ğ•’ğ•Ÿğ•”ğ•–ğ•• ğ•€ğ•Ÿğ•¥ğ•–ğ•£ğ•—ğ•’ğ•”ğ•–
âœ¦ ğŸŒ *ğ—•ğ—®ğ˜€ğ—¶ğ—° ğ—ªğ—²ğ—¯ ğ—”ğ—½ğ—½* - ğ•Šğ•¥ğ•’ğ•Ÿğ••ğ•’ğ•£ğ•• ğ”¸ğ•”ğ•”ğ•–ğ•¤ğ•¤  
âœ¦ âš¡ ğ•³ğ–ğ–Œğ– ğ•»ğ–Šğ–—ğ–‹ğ–”ğ–—ğ–’ğ–†ğ–“ğ–ˆğ–Š
âœ¦ ğŸ¨ ğ•»ğ–—ğ–Šğ–’ğ–ğ–šğ–’ ğ•¯ğ–Šğ–˜ğ–ğ–Œğ–“
âœ¦ ğŸ”’ ğ•¾ğ–Šğ–ˆğ–šğ–—ğ–Š ğ•®ğ–”ğ–“ğ–“ğ–Šğ–ˆğ–™ğ–ğ–”ğ–“
âœ¦ ğŸ“ 24/7 ğ•¾ğ–šğ–•ğ–•ğ–”ğ–—ğ–™
âœ¦ ğŸ‘‘ ğ•¬ğ–‰ğ–›ğ–†ğ–“ğ–ˆğ–Šğ–‰ ğ•¬ğ–‰ğ–’ğ–ğ–“ ğ•»ğ–†ğ–“ğ–Šğ–‘
âœ¦ ğŸ“Š ğ•½ğ–Šğ–†ğ–‘-ğ–™ğ–ğ–’ğ–Š ğ•¬ğ–“ğ–†ğ–‘ğ–ğ–™ğ–ğ–ˆğ–˜
âœ¦ ğŸ‘¥ ğ–€ğ–˜ğ–Šğ–— ğ•¸ğ–†ğ–“ğ–†ğ–Œğ–Šğ–’ğ–Šğ–“ğ–™
âœ¦ ğŸ“¢ ğ•­ğ–—ğ–”ğ–†ğ–‰ğ–ˆğ–†ğ–˜ğ–™ ğ•¾ğ–ğ–˜ğ–™ğ–Šğ–’
âœ¦ ğŸ” ğ•¬ğ–ˆğ–™ğ–ğ–›ğ–ğ–™ğ– ğ•¸ğ–”ğ–“ğ–ğ–™ğ–”ğ–—ğ–ğ–“ğ–Œ
âœ¦ ğŸš« **ğ•±ğ–ğ–ğ–Šğ–‰ ğ•­ğ–‘ğ–”ğ–ˆğ–ğ–ğ–“ğ–Œ ğ•¾ğ–ğ–˜ğ–™ğ–Šğ–’**
âœ¦ â° ğ•¬ğ–šğ–™ğ–”-ğ•¯ğ–Šğ–‘ğ–Šğ–™ğ–Š ğ•¾ğ–ğ–˜ğ–™ğ–Šğ–’ (15 ğ–’ğ–ğ–“ğ–šğ–™ğ–Šğ–˜)

ğŸ”” *ğ—£ğ—¥ğ—˜ğ— ğ—œğ—¨ğ—  ğ—•ğ—¢ğ—§ ğ—œğ—¦ ğ—¡ğ—¢ğ—ª ğ—Ÿğ—œğ—©ğ—˜ ğ—”ğ—¡ğ—— ğ—¥ğ—˜ğ—”ğ——ğ—¬!*
âœ… **ğ•­ğ–‘ğ–”ğ–ˆğ–ğ–ğ–“ğ–Œ ğ–˜ğ–ğ–˜ğ–™ğ–Šğ–’ ğ–“ğ–”ğ–œ ğ–œğ–”ğ–—ğ–ğ–ğ–“ğ–Œ ğ–•ğ–—ğ–”ğ–•ğ–Šğ–—ğ–‘ğ–!**
    """)
    
    application.run_polling()

if __name__ == '__main__':
    main()
